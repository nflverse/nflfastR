<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examples • nflfastR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Examples">
<meta property="og:description" content="nflfastR">
<meta property="og:image" content="https://raw.githubusercontent.com/mrcaseb/nflfastR/master/man/figures/card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@nflfastR">
<meta name="twitter:site" content="@nflfastR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nflfastR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.2.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/beginners_guide.html">A beginner's guide to nflfastR</a>
    </li>
    <li>
      <a href="../articles/examples.html">Examples</a>
    </li>
    <li>
      <a href="../articles/nflfastR-models.html">nflfastR EP, WP, and CP models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://twitter.com/nflfastR">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/mrcaseb/nflfastR/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="examples_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Examples</h1>
                        <h4 class="author">Ben Baldwin &amp; Sebastian Carl</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrcaseb/nflfastR/blob/master/vignettes/examples.Rmd"><code>vignettes/examples.Rmd</code></a></small>
      <div class="hidden name"><code>examples.Rmd</code></div>

    </div>

    
    
<p>All examples listed below assume that the following two libraries are installed and loaded.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">nflfastR</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)</pre></body></html></div>
<p>If you have trouble understanding the code in the examples we highly recommend the <strong>nflfastR beginner’s guide</strong> in <code><a href="../articles/beginners_guide.html">vignette("beginners_guide")</a></code>.</p>
<div id="example-1-replicate-nflscrapr-with-fast_scraper" class="section level1">
<h1 class="hasAnchor">
<a href="#example-1-replicate-nflscrapr-with-fast_scraper" class="anchor"></a>Example 1: replicate nflscrapR with fast_scraper</h1>
<p>The functionality of <code>nflscrapR</code> can be duplicated by using <code><a href="../reference/fast_scraper.html">fast_scraper()</a></code>. This obtains the same information contained in <code>nflscrapR</code> (plus some extra) but much more quickly. To compare to <code>nflscrapR</code>, we use their data repository as the program no longer functions now that the NFL has taken down the old Gamecenter feed. Note that EP differs from nflscrapR as we use a newer era-adjusted model (more on this in <code><a href="../articles/nflfastR-models.html">vignette("nflfastR-models")</a></code>).</p>
<p>This example also uses the built-in function <code><a href="../reference/clean_pbp.html">clean_pbp()</a></code> to create a ‘name’ column for the primary player involved (the QB on pass play or ball-carrier on run play).</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu">read_csv</span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://github.com/ryurko/nflscrapR-data/blob/master/play_by_play_data/regular_season/reg_pbp_2019.csv?raw=true'</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">home_team</span> <span class="kw">==</span> <span class="st">'SF'</span> <span class="kw">&amp;</span> <span class="no">away_team</span> <span class="kw">==</span> <span class="st">'SEA'</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">desc</span>, <span class="no">play_type</span>, <span class="no">ep</span>, <span class="no">epa</span>, <span class="no">home_wp</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">5</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<table class="table">
<colgroup>
<col width="78%">
<col width="6%">
<col width="4%">
<col width="4%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">desc</th>
<th align="left">play_type</th>
<th align="right">ep</th>
<th align="right">epa</th>
<th align="right">home_wp</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">J.Myers kicks 65 yards from SEA 35 to end zone, Touchback.</td>
<td align="left">kickoff</td>
<td align="right">0.815</td>
<td align="right">0.000</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">(15:00) T.Coleman left guard to SF 26 for 1 yard (J.Clowney).</td>
<td align="left">run</td>
<td align="right">0.815</td>
<td align="right">-0.606</td>
<td align="right">0.500</td>
</tr>
<tr class="odd">
<td align="left">(14:19) T.Coleman right tackle to SF 25 for -1 yards (P.Ford).</td>
<td align="left">run</td>
<td align="right">0.209</td>
<td align="right">-1.146</td>
<td align="right">0.485</td>
</tr>
<tr class="even">
<td align="left">(13:45) (Shotgun) J.Garoppolo pass short middle to K.Bourne to SF 41 for 16 yards (J.Taylor). Caught at SF39. 2-yac</td>
<td align="left">pass</td>
<td align="right">-0.937</td>
<td align="right">3.223</td>
<td align="right">0.453</td>
</tr>
<tr class="odd">
<td align="left">(12:58) PENALTY on SEA-J.Reed, Encroachment, 5 yards, enforced at SF 41 - No Play.</td>
<td align="left">no_play</td>
<td align="right">2.286</td>
<td align="right">0.774</td>
<td align="right">0.551</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="../reference/fast_scraper.html">fast_scraper</a></span>(<span class="st">'2019_10_SEA_SF'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/clean_pbp.html">clean_pbp</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">desc</span>, <span class="no">play_type</span>, <span class="no">ep</span>, <span class="no">epa</span>, <span class="no">home_wp</span>, <span class="no">name</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">6</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<table class="table">
<colgroup>
<col width="74%">
<col width="5%">
<col width="3%">
<col width="4%">
<col width="4%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="left">desc</th>
<th align="left">play_type</th>
<th align="right">ep</th>
<th align="right">epa</th>
<th align="right">home_wp</th>
<th align="left">name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">GAME</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">5-J.Myers kicks 65 yards from SEA 35 to end zone, Touchback.</td>
<td align="left">kickoff</td>
<td align="right">1.435</td>
<td align="right">0.000</td>
<td align="right">0.559</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">(15:00) 26-T.Coleman left guard to SF 26 for 1 yard (90-J.Clowney).</td>
<td align="left">run</td>
<td align="right">1.435</td>
<td align="right">-0.524</td>
<td align="right">0.559</td>
<td align="left">T.Coleman</td>
</tr>
<tr class="even">
<td align="left">(14:19) 26-T.Coleman right tackle to SF 25 for -1 yards (97-P.Ford).</td>
<td align="left">run</td>
<td align="right">0.911</td>
<td align="right">-0.850</td>
<td align="right">0.559</td>
<td align="left">T.Coleman</td>
</tr>
<tr class="odd">
<td align="left">(13:45) (Shotgun) 10-J.Garoppolo pass short middle to 84-K.Bourne to SF 41 for 16 yards (24-J.Taylor). Caught at SF39. 2-yac</td>
<td align="left">pass</td>
<td align="right">0.061</td>
<td align="right">2.417</td>
<td align="right">0.518</td>
<td align="left">J.Garoppolo</td>
</tr>
<tr class="even">
<td align="left">(12:58) PENALTY on SEA-91-J.Reed, Encroachment, 5 yards, enforced at SF 41 - No Play.</td>
<td align="left">no_play</td>
<td align="right">2.478</td>
<td align="right">0.565</td>
<td align="right">0.584</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="example-2-scrape-a-batch-of-games-very-quickly-with-fast_scraper-and-parallel-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#example-2-scrape-a-batch-of-games-very-quickly-with-fast_scraper-and-parallel-processing" class="anchor"></a>Example 2: scrape a batch of games very quickly with fast_scraper and parallel processing</h1>
<p>This is a demonstration of <code>nflfastR</code>’s capabilities. While <code>nflfastR</code> can scrape a batch of games very quickly, <strong>please be respectful of Github’s servers and use the <a href="https://github.com/guga31bb/nflfastR-data">data repository</a> which hosts all the scraped and cleaned data</strong> whenever possible. The only reason to ever actually use the scraper is if it’s in the middle of the season and we haven’t updated the repository with recent games (but we will try to keep it updated).</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co">#get list of some games from 2019</span>
<span class="no">games_2019</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fast_scraper_schedules.html">fast_scraper_schedules</a></span>(<span class="fl">2019</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">10</span>) <span class="kw">%&gt;%</span> <span class="fu">pull</span>(<span class="no">game_id</span>)

<span class="kw pkg">tictoc</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span>(<span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">'{length(games_2019)} games with nflfastR:'</span>))
<span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fast_scraper.html">fast_scraper</a></span>(<span class="no">games_2019</span>, <span class="kw">pp</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="kw pkg">tictoc</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span>()
<span class="co">#&gt; 10 games with nflfastR:: 23.48 sec elapsed</span></pre></body></html></div>
</div>
<div id="example-3-completion-percentage-over-expected-cpoe" class="section level1">
<h1 class="hasAnchor">
<a href="#example-3-completion-percentage-over-expected-cpoe" class="anchor"></a>Example 3: completion percentage over expected (CPOE)</h1>
<p>Let’s look at CPOE leaders from the 2009 regular season.</p>
<p>As discussed above, <code>nflfastR</code> has a data repository for old seasons, so there’s no need to actually scrape them. Let’s use that here (the below reads .rds files, but .csv and .parquet are also available).</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="kw pkg">tictoc</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span>(<span class="st">'loading all games from 2009'</span>)
<span class="no">games_2009</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_2009.rds'</span>)) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">season_type</span> <span class="kw">==</span> <span class="st">'REG'</span>)
<span class="kw pkg">tictoc</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span>()
<span class="co">#&gt; loading all games from 2009: 1.79 sec elapsed</span>
<span class="no">games_2009</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">cpoe</span>)) <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">passer_player_name</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(<span class="kw">cpoe</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">cpoe</span>), <span class="kw">Atts</span><span class="kw">=</span><span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">Atts</span> <span class="kw">&gt;</span> <span class="fl">200</span>) <span class="kw">%&gt;%</span>
  <span class="fu">arrange</span>(-<span class="no">cpoe</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">5</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">passer_player_name</th>
<th align="right">cpoe</th>
<th align="right">Atts</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">D.Brees</td>
<td align="right">7.5</td>
<td align="right">509</td>
</tr>
<tr class="even">
<td align="left">P.Rivers</td>
<td align="right">6.6</td>
<td align="right">474</td>
</tr>
<tr class="odd">
<td align="left">P.Manning</td>
<td align="right">6.4</td>
<td align="right">569</td>
</tr>
<tr class="even">
<td align="left">B.Favre</td>
<td align="right">6.1</td>
<td align="right">527</td>
</tr>
<tr class="odd">
<td align="left">B.Roethlisberger</td>
<td align="right">5.4</td>
<td align="right">503</td>
</tr>
</tbody>
</table>
</div>
<div id="example-4-using-drive-information" class="section level1">
<h1 class="hasAnchor">
<a href="#example-4-using-drive-information" class="anchor"></a>Example 4: using drive information</h1>
<p>When working with <code>nflfastR</code>, drive results are automatically included. Let’s look at how much more likely teams were to score starting from 1st &amp; 10 at their own 20 yard line in 2015 (the last year before touchbacks on kickoffs changed to the 25) than in 2000.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">games_2000</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_2000.rds'</span>))
<span class="no">games_2015</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_2015.rds'</span>))

<span class="no">pbp</span> <span class="kw">&lt;-</span> <span class="fu">bind_rows</span>(<span class="no">games_2000</span>, <span class="no">games_2015</span>)

<span class="no">pbp</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">season_type</span> <span class="kw">==</span> <span class="st">'REG'</span> <span class="kw">&amp;</span> <span class="no">down</span> <span class="kw">==</span> <span class="fl">1</span> <span class="kw">&amp;</span> <span class="no">ydstogo</span> <span class="kw">==</span> <span class="fl">10</span> <span class="kw">&amp;</span> <span class="no">yardline_100</span> <span class="kw">==</span> <span class="fl">80</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">drive_score</span> <span class="kw">=</span> <span class="fu">if_else</span>(<span class="no">drive_end_transition</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Touchdown"</span>, <span class="st">"Field Goal"</span>, <span class="st">"TOUCHDOWN"</span>, <span class="st">"FIELD_GOAL"</span>), <span class="fl">1</span>, <span class="fl">0</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">season</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(<span class="kw">drive_score</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">drive_score</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">season</th>
<th align="right">drive_score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">2000</td>
<td align="right">0.234</td>
</tr>
<tr class="even">
<td align="right">2015</td>
<td align="right">0.305</td>
</tr>
</tbody>
</table>
<p>So about 23% of 1st &amp; 10 plays from teams’ own 20 would see the drive end up in a score in 2000, compared to 30% in 2015. This has implications for Expected Points models (see <code><a href="../articles/nflfastR-models.html">vignette("nflfastR-models")</a></code>).</p>
</div>
<div id="example-5-plot-offensive-and-defensive-epa-per-play-for-a-given-season" class="section level1">
<h1 class="hasAnchor">
<a href="#example-5-plot-offensive-and-defensive-epa-per-play-for-a-given-season" class="anchor"></a>Example 5: Plot offensive and defensive EPA per play for a given season</h1>
<p>Let’s build the <strong><a href="https://rbsdm.com/stats/stats/">NFL team tiers</a></strong> using offensive and defensive expected points added per play for the 2005 regular season. The logo urls of the espn logos are integrated into the <code><a href="../reference/teams_colors_logos.html">?teams_colors_logos</a></code> data frame which is delivered with the package.</p>
<p>Let’s also use the included helper function <code><a href="../reference/clean_pbp.html">clean_pbp()</a></code>, which creates “rush” and “pass” columns that (a) properly count sacks and scrambles as pass plays and (b) properly include plays with penalties. Using this, we can keep only rush or pass plays.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggimage</span>)
<span class="no">pbp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_2005.rds'</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">season_type</span> <span class="kw">==</span> <span class="st">'REG'</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">posteam</span>) <span class="kw">&amp;</span> (<span class="no">rush</span> <span class="kw">==</span> <span class="fl">1</span> <span class="kw">|</span> <span class="no">pass</span> <span class="kw">==</span> <span class="fl">1</span>))
<span class="no">offense</span> <span class="kw">&lt;-</span> <span class="no">pbp</span> <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">posteam</span>) <span class="kw">%&gt;%</span> <span class="fu">summarise</span>(<span class="kw">off_epa</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">epa</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>))
<span class="no">defense</span> <span class="kw">&lt;-</span> <span class="no">pbp</span> <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">defteam</span>) <span class="kw">%&gt;%</span> <span class="fu">summarise</span>(<span class="kw">def_epa</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">epa</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>))
<span class="no">logos</span> <span class="kw">&lt;-</span> <span class="no">teams_colors_logos</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">team_abbr</span>, <span class="no">team_logo_espn</span>)

<span class="no">offense</span> <span class="kw">%&gt;%</span>
  <span class="fu">inner_join</span>(<span class="no">defense</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"posteam"</span> <span class="kw">=</span> <span class="st">"defteam"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">inner_join</span>(<span class="no">logos</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"posteam"</span> <span class="kw">=</span> <span class="st">"team_abbr"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">off_epa</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">def_epa</span>)) +
  <span class="fu">geom_abline</span>(<span class="kw">slope</span> <span class="kw">=</span> -<span class="fl">1.5</span>, <span class="kw">intercept</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.4</span>, <span class="fl">.3</span>, <span class="fl">.2</span>, <span class="fl">.1</span>, <span class="fl">0</span>, -<span class="fl">.1</span>, -<span class="fl">.2</span>, -<span class="fl">.3</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">.2</span>) +
  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">off_epa</span>)), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>) +
  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">def_epa</span>)), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggimage/man/geom_image.html">geom_image</a></span>(<span class="fu">aes</span>(<span class="kw">image</span> <span class="kw">=</span> <span class="no">team_logo_espn</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.05</span>, <span class="kw">asp</span> <span class="kw">=</span> <span class="fl">16</span> / <span class="fl">9</span>) +
  <span class="fu">labs</span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="st">"Offense EPA/play"</span>,
    <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Defense EPA/play"</span>,
    <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Data: @nflfastR"</span>,
    <span class="kw">title</span> <span class="kw">=</span> <span class="st">"2005 NFL Offensive and Defensive EPA per Play"</span>
  ) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme</span>(
    <span class="kw">aspect.ratio</span> <span class="kw">=</span> <span class="fl">9</span> / <span class="fl">16</span>,
    <span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">12</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">face</span> <span class="kw">=</span> <span class="st">"bold"</span>)
  ) +
  <span class="fu">scale_y_reverse</span>()</pre></body></html></div>
<p><img src="examples_files/figure-html/ex5-1.png" width="4375"></p>
</div>
<div id="example-6-expected-points-calculator" class="section level1">
<h1 class="hasAnchor">
<a href="#example-6-expected-points-calculator" class="anchor"></a>Example 6: Expected Points calculator</h1>
<p>We have provided a calculator for working with the Expected Points model. Here is an example of how to use it, looking for how the Expected Points on a drive beginning following a touchback has changed over time.</p>
<p>While I have put in <code>'SEA'</code> for <code>home_team</code> and <code>posteam</code>, this only matters for figuring out whether the team with the ball is the home team (there’s no actual effect for given team; it would be the same no matter what team is supplied).</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">data</span> <span class="kw">&lt;-</span> <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
  <span class="st">"season"</span> <span class="kw">=</span> <span class="fl">1999</span>:<span class="fl">2019</span>,
  <span class="st">'home_team'</span> <span class="kw">=</span> <span class="st">'SEA'</span>,
  <span class="st">'posteam'</span> <span class="kw">=</span> <span class="st">'SEA'</span>,
  <span class="st">'roof'</span> <span class="kw">=</span> <span class="st">'outdoors'</span>,
  <span class="st">'half_seconds_remaining'</span> <span class="kw">=</span> <span class="fl">1800</span>,
  <span class="st">'yardline_100'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">80</span>, <span class="fl">17</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">75</span>, <span class="fl">4</span>)),
  <span class="st">'down'</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="st">'ydstogo'</span> <span class="kw">=</span> <span class="fl">10</span>,
  <span class="st">'posteam_timeouts_remaining'</span> <span class="kw">=</span> <span class="fl">3</span>,
  <span class="st">'defteam_timeouts_remaining'</span> <span class="kw">=</span> <span class="fl">3</span>
)

<span class="kw pkg">nflfastR</span><span class="kw ns">::</span><span class="fu"><a href="../reference/calculate_expected_points.html">calculate_expected_points</a></span>(<span class="no">data</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">season</span>, <span class="no">yardline_100</span>, <span class="no">td_prob</span>, <span class="no">ep</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">season</th>
<th align="right">yardline_100</th>
<th align="right">td_prob</th>
<th align="right">ep</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1999</td>
<td align="right">80</td>
<td align="right">0.33</td>
<td align="right">0.61</td>
</tr>
<tr class="even">
<td align="right">2000</td>
<td align="right">80</td>
<td align="right">0.33</td>
<td align="right">0.61</td>
</tr>
<tr class="odd">
<td align="right">2001</td>
<td align="right">80</td>
<td align="right">0.33</td>
<td align="right">0.61</td>
</tr>
<tr class="even">
<td align="right">2002</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.80</td>
</tr>
<tr class="odd">
<td align="right">2003</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.80</td>
</tr>
<tr class="even">
<td align="right">2004</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.80</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.80</td>
</tr>
<tr class="even">
<td align="right">2006</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="odd">
<td align="right">2007</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="even">
<td align="right">2008</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="odd">
<td align="right">2009</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="even">
<td align="right">2010</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="odd">
<td align="right">2011</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="even">
<td align="right">2012</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="odd">
<td align="right">2013</td>
<td align="right">80</td>
<td align="right">0.34</td>
<td align="right">0.81</td>
</tr>
<tr class="even">
<td align="right">2014</td>
<td align="right">80</td>
<td align="right">0.35</td>
<td align="right">0.97</td>
</tr>
<tr class="odd">
<td align="right">2015</td>
<td align="right">80</td>
<td align="right">0.35</td>
<td align="right">0.97</td>
</tr>
<tr class="even">
<td align="right">2016</td>
<td align="right">75</td>
<td align="right">0.38</td>
<td align="right">1.44</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="right">75</td>
<td align="right">0.38</td>
<td align="right">1.44</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="right">75</td>
<td align="right">0.40</td>
<td align="right">1.43</td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="right">75</td>
<td align="right">0.40</td>
<td align="right">1.43</td>
</tr>
</tbody>
</table>
<p>Not surprisingly, offenses have become much more successful over time, with the kickoff touchback moving from the 20 to the 25 in 2016 providing an additional boost. Note that the <code>td_prob</code> in this example is the probability that the next score within the same half will be a touchdown scored by team with the ball, <strong>not</strong> the probability that the current drive will end in a touchdown (this is why the numbers are different from Example 4 above).</p>
<p>We could compare the most recent four years to the expectation for playing in a dome by inputting all the same things and changing the <code>roof</code> input:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">data</span> <span class="kw">&lt;-</span> <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
  <span class="st">"season"</span> <span class="kw">=</span> <span class="fl">2016</span>:<span class="fl">2019</span>,
  <span class="st">"week"</span> <span class="kw">=</span> <span class="fl">5</span>,
  <span class="st">'home_team'</span> <span class="kw">=</span> <span class="st">'SEA'</span>,
  <span class="st">'posteam'</span> <span class="kw">=</span> <span class="st">'SEA'</span>,
  <span class="st">'roof'</span> <span class="kw">=</span> <span class="st">'dome'</span>,
  <span class="st">'half_seconds_remaining'</span> <span class="kw">=</span> <span class="fl">1800</span>,
  <span class="st">'yardline_100'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">75</span>, <span class="fl">4</span>)),
  <span class="st">'down'</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="st">'ydstogo'</span> <span class="kw">=</span> <span class="fl">10</span>,
  <span class="st">'posteam_timeouts_remaining'</span> <span class="kw">=</span> <span class="fl">3</span>,
  <span class="st">'defteam_timeouts_remaining'</span> <span class="kw">=</span> <span class="fl">3</span>
)

<span class="kw pkg">nflfastR</span><span class="kw ns">::</span><span class="fu"><a href="../reference/calculate_expected_points.html">calculate_expected_points</a></span>(<span class="no">data</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">season</span>, <span class="no">yardline_100</span>, <span class="no">td_prob</span>, <span class="no">ep</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">season</th>
<th align="right">yardline_100</th>
<th align="right">td_prob</th>
<th align="right">ep</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">2016</td>
<td align="right">75</td>
<td align="right">0.41</td>
<td align="right">1.74</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="right">75</td>
<td align="right">0.41</td>
<td align="right">1.74</td>
</tr>
<tr class="odd">
<td align="right">2018</td>
<td align="right">75</td>
<td align="right">0.43</td>
<td align="right">1.74</td>
</tr>
<tr class="even">
<td align="right">2019</td>
<td align="right">75</td>
<td align="right">0.43</td>
<td align="right">1.74</td>
</tr>
</tbody>
</table>
<p>So for 2018 and 2019, 1st &amp; 10 from a home team’s own 25 yard line had EP of 1.43 outdoors and 1.74 in domes.</p>
</div>
<div id="example-7-win-probability-calculator" class="section level1">
<h1 class="hasAnchor">
<a href="#example-7-win-probability-calculator" class="anchor"></a>Example 7: Win probability calculator</h1>
<p>We have also provided a calculator for working with the win probability models. Here is an example of how to use it, looking for how the win probability to begin the game depends on the pre-game spread.</p>
<p>While I have put in <code>'SEA'</code> for <code>home_team</code> and <code>posteam</code>, this only matters for figuring out whether the team with the ball is the home team (there’s no actual effect for given team; it would be the same no matter what team is supplied).</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">data</span> <span class="kw">&lt;-</span> <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
  <span class="st">'receive_2h_ko'</span> <span class="kw">=</span> <span class="fl">0</span>,
  <span class="st">'ep'</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="st">'home_team'</span> <span class="kw">=</span> <span class="st">'SEA'</span>,
  <span class="st">'posteam'</span> <span class="kw">=</span> <span class="st">'SEA'</span>,
  <span class="st">'score_differential'</span> <span class="kw">=</span> <span class="fl">0</span>,
  <span class="st">'half_seconds_remaining'</span> <span class="kw">=</span> <span class="fl">1800</span>,
  <span class="st">'game_seconds_remaining'</span> <span class="kw">=</span> <span class="fl">3600</span>,
  <span class="st">'spread_line'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>),
  <span class="st">'down'</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="st">'ydstogo'</span> <span class="kw">=</span> <span class="fl">10</span>,
  <span class="st">'posteam_timeouts_remaining'</span> <span class="kw">=</span> <span class="fl">3</span>,
  <span class="st">'defteam_timeouts_remaining'</span> <span class="kw">=</span> <span class="fl">3</span>
)

<span class="kw pkg">nflfastR</span><span class="kw ns">::</span><span class="fu"><a href="../reference/calculate_win_probability.html">calculate_win_probability</a></span>(<span class="no">data</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">spread_line</span>, <span class="no">wp</span>, <span class="no">vegas_wp</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">spread_line</th>
<th align="right">wp</th>
<th align="right">vegas_wp</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0.56</td>
<td align="right">0.57</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">0.56</td>
<td align="right">0.67</td>
</tr>
<tr class="odd">
<td align="right">10</td>
<td align="right">0.56</td>
<td align="right">0.80</td>
</tr>
<tr class="even">
<td align="right">15</td>
<td align="right">0.56</td>
<td align="right">0.91</td>
</tr>
</tbody>
</table>
<p>Not surprisingly, <code>vegas_wp</code> increases with the amount a team was coming into the game favored by. Weirdly, the model thinks home teams are more likely to win even when the spread is 0. I’m not sure how much to believe the model on that one, but leaving <code>home</code> in the model did make the model better at out of sample predictions, so who knows.</p>
</div>
<div id="example-8-using-the-built-in-database-function" class="section level1">
<h1 class="hasAnchor">
<a href="#example-8-using-the-built-in-database-function" class="anchor"></a>Example 8: Using the built-in database function</h1>
<p>If you’re comfortable using <code>dplyr</code> functions to manipulate and tidy data, you’re ready to use a database. Why should you use a database?</p>
<ul>
<li>The provided function in <code>nflfastR</code> makes it extremely easy to build a database and keep it updated</li>
<li>Play-by-play data over 20+ seasons takes up a lot of memory: working with a database allows you to only bring into memory what you actually need</li>
<li>R makes it <em>extremely</em> easy to work with databases.</li>
</ul>
<div id="start-install-and-load-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#start-install-and-load-packages" class="anchor"></a>Start: install and load packages</h2>
<p>To start, we need to install the two packages required for this that aren’t installed automatically when <code>nflfastR</code> installs: <code>DBI</code> and <code>RSQLite</code>:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"DBI"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"RSQLite"</span>)</pre></body></html></div>
<p>As with always, you only need to install these once. They don’t need to be loaded to build the database because <code>nflfastR</code> knows how to use them, but we do need them later on when working with the database.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">DBI</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RSQLite</span>)</pre></body></html></div>
</div>
<div id="build-database" class="section level2">
<h2 class="hasAnchor">
<a href="#build-database" class="anchor"></a>Build database</h2>
<p>There’s exactly one function in <code>nflfastR</code> that works with databases: <code>update_db</code>. Some notes:</p>
<ul>
<li>If you use <code><a href="../reference/update_db.html">update_db()</a></code> with no arguments, it will build a SQLite database called <code>pbp_db</code> in your current working directory, with play-by-play data in a table called <code>nflfastR_pbp</code>.</li>
<li>You can specify a different directory with <code>dbdir</code>.</li>
<li>You can specify a different filename with <code>dbname</code>.</li>
<li>You can specify a different table name with <code>tblname</code>.</li>
<li>If you want to rebuild the database from scratch for whatever reason, supply <code>force_rebuild = TRUE</code>. This is primarily intended for the case when we update the play-by-play data in the data repo due to fixing a bug and you want to force the database to be wiped and updated.</li>
</ul>
<p>Let’s say I just want to dump a database into the current working directory. Here we go!</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="../reference/update_db.html">update_db</a></span>()
<span class="co">#&gt; Can't find database ./pbp_db. Will try to create it and load the play by play data into the data table "nflfastR_pbp".</span>
<span class="co">#&gt; Starting download of 21 seasons between 1999 and 2019...</span>
<span class="co">#&gt; Checking for missing completed games...</span>
<span class="co">#&gt; You have 5580 games and are missing 0.</span></pre></body></html></div>
<p>This created a database in the current directory called <code>pbp_db</code>.</p>
<p>Wait, that’s it? That’s it! What if it’s partway through the season and you want to make sure all the new games are added to the database? What do you run? <code><a href="../reference/update_db.html">update_db()</a></code>! (just make sure you’re in the directory the database is saved in or you supply the right file path)</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="../reference/update_db.html">update_db</a></span>()
<span class="co">#&gt; Checking for missing completed games...</span>
<span class="co">#&gt; You have 5580 games and are missing 0.</span></pre></body></html></div>
</div>
<div id="connect-to-database" class="section level2">
<h2 class="hasAnchor">
<a href="#connect-to-database" class="anchor"></a>Connect to database</h2>
<p>Now we can make a connection to the database. This is the only part that will look a little bit foreign, but all you need to know is where your database is located. If it’s in your current working directory, this will work:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">connection</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(<span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span>(), <span class="st">"./pbp_db"</span>)
<span class="no">connection</span>
<span class="co">#&gt; &lt;SQLiteConnection&gt;</span>
<span class="co">#&gt;   Path: D:\11_Coding\R\nflfastR\vignettes\pbp_db</span>
<span class="co">#&gt;   Extensions: TRUE</span></pre></body></html></div>
<p>It looks like nothing happened, but we now have a connection to the database. Now we’re ready to do stuff. If you aren’t familiar with databases, they’re organized around tables. Here’s how to see which tables are present in our database:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListTables.html">dbListTables</a></span>(<span class="no">connection</span>)
<span class="co">#&gt; [1] "nflfastR_pbp"</span></pre></body></html></div>
<p>Since we went with the defaults, there’s a table called <code>nflfastR_pbp</code>. Another useful function is to see the fields (i.e., columns) in a table:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListFields.html">dbListFields</a></span>(<span class="no">connection</span>, <span class="st">"nflfastR_pbp"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">10</span>)
<span class="co">#&gt;  [1] "play_id"      "game_id"      "old_game_id"  "home_team"    "away_team"   </span>
<span class="co">#&gt;  [6] "season_type"  "week"         "posteam"      "posteam_type" "defteam"</span></pre></body></html></div>
<p>This is the same list as the list of columns in <code>nflfastR</code> play-by-play. Notice we had to supply the name of the table above (<code>"nflfastR_pbp"</code>).</p>
<p>With all that out of the way, there’s only a couple more things to learn. The main driver here is <code>tbl</code>, which helps get output with a specific table in a database:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">pbp_db</span> <span class="kw">&lt;-</span> <span class="fu">tbl</span>(<span class="no">connection</span>, <span class="st">"nflfastR_pbp"</span>)</pre></body></html></div>
<p>And now, everything will magically just “work”: you can forget you’re even working with a database!</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">pbp_db</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">season</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(<span class="kw">n</span><span class="kw">=</span><span class="fu">n</span>())
<span class="co">#&gt; # Source:   lazy query [?? x 2]</span>
<span class="co">#&gt; # Database: sqlite 3.30.1 [D:\11_Coding\R\nflfastR\vignettes\pbp_db]</span>
<span class="co">#&gt;    season     n</span>
<span class="co">#&gt;     &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1   1999 46137</span>
<span class="co">#&gt;  2   2000 45492</span>
<span class="co">#&gt;  3   2001 45435</span>
<span class="co">#&gt;  4   2002 47819</span>
<span class="co">#&gt;  5   2003 47335</span>
<span class="co">#&gt;  6   2004 47203</span>
<span class="co">#&gt;  7   2005 47344</span>
<span class="co">#&gt;  8   2006 46868</span>
<span class="co">#&gt;  9   2007 46789</span>
<span class="co">#&gt; 10   2008 46445</span>
<span class="co">#&gt; # ... with more rows</span>

<span class="no">pbp_db</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">rush</span> <span class="kw">==</span> <span class="fl">1</span> <span class="kw">|</span> <span class="no">pass</span> <span class="kw">==</span> <span class="fl">1</span>, <span class="no">down</span> <span class="kw">&lt;=</span> <span class="fl">2</span>, !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">epa</span>), !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">posteam</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">pass</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(<span class="kw">mean_epa</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">epa</span>))
<span class="co">#&gt; Warning: Missing values are always removed in SQL.</span>
<span class="co">#&gt; Use `mean(x, na.rm = TRUE)` to silence this warning</span>
<span class="co">#&gt; This warning is displayed only once per session.</span>
<span class="co">#&gt; # Source:   lazy query [?? x 2]</span>
<span class="co">#&gt; # Database: sqlite 3.30.1 [D:\11_Coding\R\nflfastR\vignettes\pbp_db]</span>
<span class="co">#&gt;    pass mean_epa</span>
<span class="co">#&gt;   &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1     0  -0.0955</span>
<span class="co">#&gt; 2     1   0.0733</span></pre></body></html></div>
<p>So far, everything has stayed in the database. If you want to bring a query into memory, just use <code>collect()</code> at the end:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">russ</span> <span class="kw">&lt;-</span> <span class="no">pbp_db</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">name</span> <span class="kw">==</span> <span class="st">"R.Wilson"</span> <span class="kw">&amp;</span> <span class="no">posteam</span> <span class="kw">==</span> <span class="st">"SEA"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">desc</span>, <span class="no">epa</span>) <span class="kw">%&gt;%</span>
  <span class="fu">collect</span>()

<span class="no">russ</span>
<span class="co">#&gt; # A tibble: 5,673 x 2</span>
<span class="co">#&gt;    desc                                                                      epa</span>
<span class="co">#&gt;    &lt;chr&gt;                                                                   &lt;dbl&gt;</span>
<span class="co">#&gt;  1 (14:12) 3-R.Wilson pass short right to 18-S.Rice to SEA 34 for 9 ya~  1.06   </span>
<span class="co">#&gt;  2 (12:53) 3-R.Wilson pass incomplete deep left to 18-S.Rice. PENALTY ~  2.68   </span>
<span class="co">#&gt;  3 (11:25) (Shotgun) 3-R.Wilson pass incomplete short right to 18-S.Ri~ -1.32   </span>
<span class="co">#&gt;  4 (10:24) (Shotgun) 3-R.Wilson pass short left to 18-S.Rice to ARI 31~  0.919  </span>
<span class="co">#&gt;  5 (9:47) 3-R.Wilson scrambles right end ran ob at ARI 27 for 4 yards ~ -0.00504</span>
<span class="co">#&gt;  6 (8:35) 3-R.Wilson pass incomplete short right to 18-S.Rice.          -0.425  </span>
<span class="co">#&gt;  7 (7:54) (Shotgun) 3-R.Wilson left end pushed ob at ARI 9 for 4 yards~ -1.19   </span>
<span class="co">#&gt;  8 (:27) 3-R.Wilson sacked at SEA 17 for -5 yards (51-P.Lenon). Penalt~ -0.971  </span>
<span class="co">#&gt;  9 (14:28) (Shotgun) 3-R.Wilson pass short right to 17-B.Edwards to SE~  1.91   </span>
<span class="co">#&gt; 10 (13:59) 3-R.Wilson pass incomplete deep left to 87-B.Obomanu.        -0.501  </span>
<span class="co">#&gt; # ... with 5,663 more rows</span></pre></body></html></div>
<p>So we’ve searched through about 1 million rows of data across 300+ columns and only brought about 5,500 rows and two columns into memory. Pretty neat! This is how I supply the data to the shiny apps on rbsdm.com without running out of memory on the server. Now there’s only one more thing to remember. When you’re finished doing what you need with the database:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span>(<span class="no">connection</span>)</pre></body></html></div>
<p>For more details on using a database with <code>nflfastR</code>, see <a href="https://themockup.blog/posts/2019-04-28-nflfastr-dbplyr-rsqlite/">Thomas Mock’s life-changing post here</a>.</p>
</div>
</div>
<div id="example-9-working-with-the-expected-yards-after-catch-model" class="section level1">
<h1 class="hasAnchor">
<a href="#example-9-working-with-the-expected-yards-after-catch-model" class="anchor"></a>Example 9: working with the expected yards after catch model</h1>
<p>The variables in <code>xyac</code> are as follows:</p>
<ul>
<li>
<code>xyac_epa</code>: The expected value of EPA gained after the catch, <strong>starting from where the catch was made</strong>.</li>
<li>
<code>xyac_success</code>: The probability the play earns positive EPA (relative to where play started) based on where ball was caught.</li>
<li>
<code>xyac_fd</code>: Probability play earns a first down based on where the ball was caught.</li>
<li>
<code>xyac_mean_yardage</code> and <code>xyac_median_yardage</code>: Average and median expected yards after the catch based on where the ball was caught.</li>
</ul>
<p>Some other notes:</p>
<ul>
<li>
<code>epa</code> = <code>air_epa</code> + <code>yac_epa</code>, where <code>air_epa</code> is the EPA associated with a catch at the target location. If a receiver loses a fumble, it is removed from his <code>yac_epa</code>
</li>
<li>Expected value of EPA at catch point = <code>air_epa</code> + <code>xyac_epa</code>
</li>
<li>So if we want to get YAC EPA over expected, we need to compare <code>yac_epa</code> to <code>xyac_epa</code>, as in the example below</li>
<li>To get first downs over expected, we could compare <code>first_down</code> to <code>xyac_fd</code>
</li>
<li>These fields are populated for all pass attempts, whether caught or not, but restrict to completed passes when measuring, for example, YAC EPA over expected</li>
<li>The expected YAC EPA model doesn’t take receiver fumbles into account, so actual minus expected YAC is slightly negative due to fumbles happening</li>
</ul>
<p>Let’s create measures for EPA and first downs over expected in 2015:</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">games_2015</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">receiver</span>, <span class="no">receiver_id</span>, <span class="no">posteam</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">tgt</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">complete_pass</span> + <span class="no">incomplete_pass</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">tgt</span> <span class="kw">&gt;=</span> <span class="fl">50</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">complete_pass</span> <span class="kw">==</span> <span class="fl">1</span>, <span class="no">air_yards</span> <span class="kw">&lt;</span> <span class="no">yardline_100</span>, !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">xyac_epa</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(
    <span class="kw">epa_oe</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">yac_epa</span> - <span class="no">xyac_epa</span>),
    <span class="kw">actual_fd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">first_down</span>),
    <span class="kw">expected_fd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">xyac_fd</span>),
    <span class="kw">fd_oe</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">first_down</span> - <span class="no">xyac_fd</span>),
    <span class="kw">rec</span> <span class="kw">=</span> <span class="fu">n</span>()
    ) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">receiver</span>, <span class="no">posteam</span>, <span class="no">actual_fd</span>, <span class="no">expected_fd</span>, <span class="no">fd_oe</span>, <span class="no">epa_oe</span>, <span class="no">rec</span>) <span class="kw">%&gt;%</span>
  <span class="fu">arrange</span>(-<span class="no">epa_oe</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">10</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">receiver</th>
<th align="left">posteam</th>
<th align="right">actual_fd</th>
<th align="right">expected_fd</th>
<th align="right">fd_oe</th>
<th align="right">epa_oe</th>
<th align="right">rec</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">D.Johnson</td>
<td align="left">ARI</td>
<td align="right">0.500</td>
<td align="right">0.391</td>
<td align="right">0.109</td>
<td align="right">0.333</td>
<td align="right">50</td>
</tr>
<tr class="even">
<td align="left">R.Gronkowski</td>
<td align="left">NE</td>
<td align="right">0.688</td>
<td align="right">0.615</td>
<td align="right">0.073</td>
<td align="right">0.265</td>
<td align="right">80</td>
</tr>
<tr class="odd">
<td align="left">J.White</td>
<td align="left">NE</td>
<td align="right">0.489</td>
<td align="right">0.434</td>
<td align="right">0.055</td>
<td align="right">0.257</td>
<td align="right">47</td>
</tr>
<tr class="even">
<td align="left">T.Ginn</td>
<td align="left">CAR</td>
<td align="right">0.800</td>
<td align="right">0.734</td>
<td align="right">0.066</td>
<td align="right">0.247</td>
<td align="right">45</td>
</tr>
<tr class="odd">
<td align="left">D.Lewis</td>
<td align="left">NE</td>
<td align="right">0.472</td>
<td align="right">0.309</td>
<td align="right">0.163</td>
<td align="right">0.235</td>
<td align="right">36</td>
</tr>
<tr class="even">
<td align="left">L.Green</td>
<td align="left">LAC</td>
<td align="right">0.629</td>
<td align="right">0.526</td>
<td align="right">0.103</td>
<td align="right">0.221</td>
<td align="right">35</td>
</tr>
<tr class="odd">
<td align="left">O.Beckham Jr.</td>
<td align="left">NYG</td>
<td align="right">0.692</td>
<td align="right">0.706</td>
<td align="right">-0.014</td>
<td align="right">0.207</td>
<td align="right">91</td>
</tr>
<tr class="even">
<td align="left">T.Riddick</td>
<td align="left">DET</td>
<td align="right">0.400</td>
<td align="right">0.304</td>
<td align="right">0.096</td>
<td align="right">0.202</td>
<td align="right">80</td>
</tr>
<tr class="odd">
<td align="left">G.Bernard</td>
<td align="left">CIN</td>
<td align="right">0.373</td>
<td align="right">0.289</td>
<td align="right">0.083</td>
<td align="right">0.195</td>
<td align="right">51</td>
</tr>
<tr class="even">
<td align="left">D.Woodhead</td>
<td align="left">LAC</td>
<td align="right">0.468</td>
<td align="right">0.354</td>
<td align="right">0.114</td>
<td align="right">0.168</td>
<td align="right">77</td>
</tr>
</tbody>
</table>
<p>The presence of so many running backs on this list suggests that even though it takes into account target depth and pass direction, the model doesn’t do a great job capturing space. Alternatively, running backs might be better at generating yards after the catch since running with the football is their primary role.</p>
</div>
<div id="example-10-working-with-roster-and-position-data" class="section level1">
<h1 class="hasAnchor">
<a href="#example-10-working-with-roster-and-position-data" class="anchor"></a>Example 10: Working with roster and position data</h1>
<p>This section used to contain an example of working with roster data. Unfortunately, we have not found a way to obtain roster data that can be joined to the new play by play, so for now, it is empty. We would like to be able to get position data but haven’t yet.</p>
<p>The <code><a href="../reference/clean_pbp.html">clean_pbp()</a></code> function does a lot of work cleaning up player names and IDs for the purpose of joining them to roster data, but we do not have any roster data to join to. <code><a href="../reference/clean_pbp.html">clean_pbp()</a></code> does standardize player IDs so that they are unique for each player across seasons.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/mrcaseb">Sebastian Carl</a>, <a href="https://twitter.com/benbbaldwin">Ben Baldwin</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
